# Handwrite-OCR: 손글씨 노트 디지털화 프로젝트

> 손글씨의 장점은 유지하면서, 디지털의 편의성을 더하다

## 목차
- [배경](#배경)
- [문제 정의](#문제-정의)
- [해결 전략](#해결-전략)
- [시스템 아키텍처](#시스템-아키텍처)
- [핵심 챌린지: 할루시네이션 해결](#핵심-챌린지-할루시네이션-해결)
- [기술 스택](#기술-스택)
- [실행 방법](#실행-방법)
- [결과 및 성과](#결과-및-성과)
- [한계 및 개선 방향](#한계-및-개선-방향)

---

## 배경

### 문제 상황

손글씨 필기는 다이어그램, 수식, 그림을 자유롭게 표현할 수 있고 타이핑보다 기억에 오래 남는다는 장점이 있습니다. 하지만 다음과 같은 한계가 있습니다:

- **검색 불가능**: 특정 내용을 찾으려면 노트를 일일이 뒤져야 함
- **분산 관리**: 타이핑 필기와 분리되어 전체 학습 내용 파악이 어려움
- **공유 및 백업 어려움**: 물리적 매체의 한계

### 목표

**손글씨의 장점**은 유지하면서 **디지털의 편의성**을 더하는 것이 목표입니다.

- 자유로운 표현 + 검색 가능한 텍스트
- 기억 효과 + 통합 관리
- 아날로그 감성 + 디지털 효율

이를 위해 손글씨 노트 이미지를 구조화된 JSON 텍스트로 변환하는 하이브리드 OCR 시스템을 구축했습니다.

---

## 문제 정의

손글씨를 디지털화하려면 OCR이 필요한데, 기존 접근법에는 각각 치명적인 한계가 있었습니다.

### 기존 접근법의 딜레마

| | 전통적인 OCR | LLM 기반 OCR |
|-----------------|-------------|-------------|
| **정확도** | 원본에 충실 |  할루시네이션 위험 |
| **텍스트 정제** | 오탈자 많음, 문맥 무시 | 구조화, 문맥 반영 |
| **표/그래프 이해** | 텍스트만 추출 | 이미지 캡셔닝 가능 |

**핵심 질문:**
> 어떻게 할루시네이션 없이 정제된 텍스트를 얻을 수 있을까?

---

## 해결 전략

### OCR First, LLM Second 하이브리드 파이프라인

전통적 OCR의 정확성과 LLM의 정제 능력을 결합한 4단계 파이프라인:

**1단계: 노트 경계 검출 및 정면화**
- DocAligner를 사용해 사진 속 노트의 경계를 검출
- 왜곡된 각도를 보정하여 정면 이미지로 변환
- 목적: OCR 정확도 향상을 위한 전처리

**2단계: 레이아웃 분석**
- OpenCV Hough Line Transform으로 노트 내부 분할선 검출
- 영역 개수 파악 (단일/2분할/4분할)
- 목적: 읽기 순서가 올바른 텍스트 추출

**3단계: 영역별 OCR 처리**
- Google Cloud Vision API로 각 영역을 독립적으로 OCR
- 실제 손글씨 텍스트만 추출 (원본 충실도 확보)
- 목적: 할루시네이션 없는 정확한 원본 확보

**4단계: LLM 후처리**
- GPT-4o-mini로 OCR 결과를 구조화된 JSON으로 변환
- **중요**: OCR 결과만을 기반으로 수정하도록 프롬프트 제한
- 목적: 할루시네이션 방지 + 오탈자 교정 + 구조화

### 레이아웃 분석이 필요한 이유

손글씨 노트는 종종 2분할(좌/우) 또는 4분할 레이아웃을 사용합니다.

**문제점:**
전체 이미지를 한 번에 OCR하면 읽기 순서가 꼬임 (좌→우→좌→우 vs 좌 전체→우 전체)

**해결책:**
1. 레이아웃 자동 분석 (OpenCV Hough Line Transform)
2. 영역별로 이미지 분리
3. 각 영역을 독립적으로 OCR → 정제
4. 문맥이 유지되고 읽기 순서가 명확한 결과 산출

---

## 시스템 아키텍처

### 4단계 파이프라인

(작업 중)

---

## 핵심 챌린지: 할루시네이션 해결

(작업 중)

**2. Temperature 조정**
```python
temperature=0.3  # 낮은 값 → 창의성 억제 → 할루시네이션 감소
```

**3. 프롬프트 엔지니어링**
```
"제공된 OCR 텍스트만을 기반으로 수정하세요"
"없는 내용을 추가하지 마세요"
"원본의 의미를 유지하면서 오탈자만 수정하세요"
```

**4. 실제 테스트 검증**
(작업 중)

### 현재 성과
(작업 중)

---

## 기술 스택

### 선택 기준과 근거

| 기술 | 사용 이유 |
|------|----------|
| **DocAligner** | 노트 경계 검출에 특화된 딥러닝 모델 (94% 정확도) |
| **OpenCV** | 이미지 처리 및 Hough Line Transform 구현 |
| **Google Cloud Vision** | 손글씨 OCR에서 검증된 상용 API (document_text_detection) |
| **OpenAI GPT-4o-mini** | 저가 모델 활용 + 구조화 능력 우수 |

---

## 실행 방법

### 1. 사전 준비

**필수 요구사항:**
- Python 3.10 이상 (3.11.9 권장)
- Google Cloud Vision API 인증 정보
- OpenAI API 키

### 2. 설치

```bash
# 가상환경 생성 및 활성화
python -m venv venv
source venv/bin/activate  # Mac/Linux
# venv\Scripts\activate   # Windows

# 패키지 설치
pip install -r requirements.txt
```

### 3. 환경 설정

`.env` 파일 생성:
```bash
GOOGLE_APPLICATION_CREDENTIALS=path/to/your/google-credentials.json
OPENAI_API_KEY=your-openai-api-key
IMAGE_DIRECTORY=./test_images
IMAGE_FILENAME=your_image.jpg
```

### 4. 실행

**전체 파이프라인 실행 (권장):**
```bash
python run_analysis.py
```

**단계별 실행:**
(수정 예정 (자바 하이브리드 아키텍쳐로 변경 예정))
```bash
# Stage 1: 경계 검출
python note_boundary_detector.py

# Stage 2: 레이아웃 분석
python note_layout_analyzer.py

# Stage 3: OCR 처리
python note_ocr_processor.py

# Stage 4: LLM 후처리
python note_llm_postprocessor.py
```

**레이아웃 분석 없는 단순 OCR (비교용):**
```bash
python simple_vision_ocr.py
```

### 5. 출력 파일

(작업 중)

---

## 결과 및 성과

(작업 중)

---

## 한계 및 개선 방향

### 현재 한계

**1. 정제 vs 할루시네이션 Trade-off**
- Temperature, 프롬프트로 완화했지만 완전 해결은 어려움
- 정제 강도를 높이면 할루시네이션 위험 증가

**2. 레이아웃 제약**
- 현재 지원: 0/2/4 영역만
- 미지원: 가로 분할, 곡선 분할, 불규칙 레이아웃

**3. OCR 품질 의존성**
- 손글씨 가독성에 따라 정확도 편차 큼
- 휘갈겨 쓴 글씨는 인식률 저하

**4. 비용**
- Google Vision API: 이미지당 과금
- OpenAI GPT-4: 토큰당 과금
- 대량 처리 시 비용 고려 필요

### 향후 개선 방향

**단기 (기능 개선):**
- [ ] 사용자가 정제 강도를 조절할 수 있는 옵션 추가
- [ ] OCR 신뢰도 기반 선택적 정제 (확신도 낮은 부분만 LLM 처리)
- [ ] 다양한 레이아웃 패턴 지원 (가로 분할, 3분할 등)
- [ ] 배치 처리 기능 (여러 이미지 한 번에 처리)

**중기 (품질 개선):**
- [ ] 다중 모델 앙상블 (여러 LLM 결과 비교 후 최적 선택)
- [ ] 사용자 피드백 루프 (수정 내역 학습)
- [ ] 표/그래프 영역 자동 감지 및 별도 처리
- [ ] 테스트 스위트 구축 및 자동화

**장기 (통합 관리):**
- [ ] 웹 UI 개발 (드래그 앤 드롭 업로드, 실시간 미리보기)
- [ ] 검색 가능한 노트 데이터베이스 구축
- [ ] 타이핑 필기와 통합 관리 플랫폼
- [ ] 플래시카드/Q&A 자동 생성 기능

---

## 라이선스 및 주의사항

**사용 API:**
- Google Cloud Vision API (유료)
- OpenAI API (유료)